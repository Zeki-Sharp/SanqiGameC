# 1. 结构解耦和职责梳理

## 目标
明确各核心组件的单一职责，减少模块间直接引用和逻辑混杂，为后续功能扩展和维护打下基础。

---

### 1. BlockPlacementManager 拆分与重构  [已完成]

#### 现状
- 该类集成了输入处理、预览逻辑、建造落地、数据缓存、颜色管理等多重职责，方法数量多，部分逻辑与UI、地图、预览等强耦合。

#### 拆分建议
- **输入与交互处理**：抽离出 `BlockPlacementInputHandler`，专门负责鼠标、键盘、UI按钮等输入事件的监听与分发。
- **预览与高亮逻辑**：抽离出 `BlockPreviewSystem`，负责生成、刷新、销毁预览对象，管理高亮、可放置/不可放置等状态显示。
- **实际建造与数据落地**：保留在 `BlockPlacementManager`，仅负责根据输入和预览结果，最终生成方块和塔，并与 `GameMap` 交互。

#### 具体方案
- 新建 `BlockPlacementInputHandler.cs`，将 `Update`、`HandlePlacementInput` 及相关输入检测逻辑迁移至此类，并通过事件或回调与主流程解耦。
- 新建 `BlockPreviewSystem.cs`，将 `UpdatePreviewTowerGroupFollowMouse`、`GeneratePreviewTowers`、`ChangePreviewTowersColor`、`UpdatePreviewTowerPositions` 等与预览相关的方法迁移至此类。
- `BlockPlacementManager` 只保留 `StartPlacement`、`StopPlacement`、`PlaceBlockAtPosition`、`PlaceTowerGroupAtPositions` 等核心建造方法，并通过接口与上述两个新组件协作。
- 通过事件（如UnityEvent或自定义C#事件）连接输入、预览、建造三者，避免直接引用。

---

### 2. PreviewAreaController 职责边界  [已完成]

#### 现状
- 该类既负责预览区域Tilemap的生成与刷新，又与主建造流程（如调用 `blockPlacementManager.PlaceTowerGroupAtPositions`）存在耦合。

#### 优化建议
- 明确 `PreviewAreaController` 只负责预览区域的Tilemap生成、刷新、对齐、清理等，不直接参与主建造流程。
- 预览区域的方块/塔生成、坐标调整等逻辑应全部通过 `BlockPreviewSystem` 统一调度，`PreviewAreaController` 仅暴露必要的Tilemap操作接口。

#### 【优化结果说明】
- 通过事件系统（EventBus）彻底解耦PreviewAreaController与主建造流程，所有建造请求均通过事件派发。
- 解决了首次ShowArea Block不可见问题，所有生成流程均可见且可控。
- 结构已完全符合单一职责和解耦目标。

#### 【具体执行计划】
1. 梳理PreviewAreaController中所有与BlockPlacementManager/建造流程相关的直接调用（如PlaceTowerGroupAtPositions）。
2. 将这些调用改为通过事件（如EventBus）派发“预览区域生成/刷新/确认建造”等消息，由BlockPlacementManager等订阅并响应。
3. 只保留Tilemap生成、刷新、对齐等接口，移除与建造流程相关的直接引用。
4. 在Unity编辑器中调整组件引用，确保解耦后功能正常。
5. 测试预览区域与建造流程的协作，确保无功能回退。

---

### 3. GameMap 职责边界  [已完成]

#### 现状
- 负责地图数据、格子占用判定、Tilemap可视化、方块放置/移除等，部分方法被UI和建造流程直接调用。

#### 优化建议
- 保持 `GameMap` 只负责地图数据、格子占用、Tilemap操作，不涉及UI和建造流程的具体逻辑。
- 所有与UI、预览、建造相关的操作应通过接口或事件与 `GameMap` 交互，避免直接操作其内部数据结构。

---

### 4. Block、Tower 职责边界  [已完成]

#### 现状
- `Block` 负责自身配置、塔的生成与管理，部分情况下直接与全局建造流程交互。
- `Tower` 负责自身数据、表现、攻击逻辑，部分初始化过程依赖外部状态。

#### 优化建议
- `Block` 仅负责自身数据、塔的生成与管理，不直接操作全局建造流程（如地图、UI等）。
- `Tower` 仅负责自身表现和战斗逻辑，初始化时通过参数注入所需数据，避免依赖全局状态。

---

### 5. 事件与接口设计  [部分完成]

- 采用事件驱动（如C#事件、UnityEvent、或自定义消息系统）解耦输入、预览、建造、地图等模块。
- 明确各模块对外暴露的接口，禁止跨层直接访问内部数据。

#### 【具体执行计划】
1. 梳理建造流程中所有交互节点（如点击建造、取消、预览刷新、放置成功/失败等）。
2. 为每个交互节点定义专用事件参数结构，避免传递不明对象。
3. 将原有的直接方法调用改为EventBus.Publish/Subscribe模式。
4. 在BlockPlacementManager、BlockPlacementInputHandler、BlockPreviewSystem等相关脚本中，替换为事件驱动。
5. 测试所有建造相关交互流程，确保事件派发与响应无遗漏。

---

### 6. 具体落地步骤

1. **梳理现有BlockPlacementManager所有方法，分类标注职责归属。**  [已完成]
2. **新建InputHandler、PreviewSystem等脚本，迁移对应方法与字段。**  [已完成]
3. **调整各模块间的引用关系，改为事件/接口协作。**  [部分完成]
4. **在主场景中将新组件分别挂载到合适的GameObject上，配置依赖。**  [已完成]
5. **测试建造流程，确保功能不变。**  [已完成]
6. **文档化各模块职责与接口说明，便于团队协作。**  [已完成]

---

### 7. 相关遗留与注意事项

- `BlockShape` 已为老旧代码，后续可彻底清理，统一用 `BlockGenerationConfig`。
- 预览与建造流程的UI事件建议全部通过 `EventBus` 派发，后续可在第二步优化中细化。
- 拆分过程中如需调整Prefab、Inspector引用，需同步在Unity编辑器中配置。

---

> 本文档为建造系统优化第一步的详细方案，所有建议均基于当前项目实际代码结构分析。后续如需细化每个脚本的迁移内容、事件接口定义等，可在下一阶段逐项展开。 

---

> 本轮优化已彻底解耦PreviewAreaController与主建造流程，采用事件驱动，修复了首次ShowArea Block不可见问题，结构清晰、职责单一，便于后续维护和扩展。 