# 场景层级管理器实现计划

## 1. 项目概述

### 1.1 目标
创建一个简单的场景层级管理器，将enemy、tower、bullet、场景设施等游戏对象放在同一个Sorting Layer中，通过sortingOrder自动管理前后遮挡关系，实现基于位置的正确渲染顺序。

### 1.2 现状分析
- **塔**：目前通过代码动态设置sortingOrder，逻辑分散在Tower.cs中
- **敌人**：在预制体中固定设置为"Enemy" Sorting Layer
- **场景物体**：使用默认层级设置
- **问题**：层级管理分散，塔需要手动设置，敌人层级固定

### 1.3 解决方案
- enemy、tower、bullet、场景设施使用同一个Sorting Layer（如"GameObjects"）
- 通过sortingOrder自动排序，Y轴位置决定渲染顺序
- 移除塔的复杂层级设置逻辑
- 敌人预制体不再固定Sorting Layer
- 所有对象平等排序，完全由位置决定遮挡关系
- 管理器自动检测和注册相关对象，无需手动挂脚本

## 2. 系统设计

### 2.1 核心思路
```
统一Sorting Layer: "GameObjects"
- 所有enemy、tower、bullet、场景设施对象都在同一个层
- 通过sortingOrder控制前后遮挡关系
- Y轴位置决定渲染顺序：Y值越大，sortingOrder越小（越靠后）
- 塔可以挡住敌人，敌人也可以挡住塔，完全由位置决定
- 场景设施（床、电视、灯、盆栽等）也参与遮挡关系
```

### 2.2 排序规则
- **Y轴位置**：Y值越大，sortingOrder越小（越靠后）
- **对象类型**：不区分类型，所有对象平等排序
- **遮挡关系**：完全由位置决定，塔可以挡住敌人，敌人也可以挡住塔，场景设施也参与遮挡
- **自动更新**：位置变化时自动重新计算层级
- **标签识别**：通过标签自动识别不同类型的对象

## 3. 实现方案

### 3.1 创建SceneLayerManager
- 单例管理器，统一管理enemy、tower、bullet、场景设施的层级
- 自动检测场景中的塔、敌人、子弹、场景物体等对象
- 根据Y轴位置自动设置sortingOrder
- 通过标签系统自动识别和注册对象

### 3.2 移除现有层级设置
- 删除Tower.cs中的SetOrder、SetCenterTowerOrder等方法
- 敌人预制体移除固定的Sorting Layer设置
- enemy、tower、bullet、场景设施使用统一的"GameObjects"层
- 移除所有手动的层级设置代码

### 3.3 自动层级计算
- 所有对象：baseOrder = 0 + Y轴偏移
- 不区分对象类型，统一计算
- 公式：sortingOrder = -Y坐标值（Y越大，值越小，越靠后）
- 场景设施、敌人、塔、子弹都在同一套计算规则下

## 4. 实施步骤

### 4.1 第一阶段：创建管理器
1. 创建SceneLayerManager脚本
2. 实现自动对象检测和注册（通过标签识别）
3. 实现简单的sortingOrder计算逻辑
4. 设置标签系统：SceneObject、Enemy、Tower、CenterTower、Bullet

### 4.2 第二阶段：集成现有系统
1. 修改Tower.cs，移除层级设置代码
2. 更新敌人预制体，移除固定Sorting Layer
3. 等待我测试自动层级管理功能

### 4.3 第三阶段：优化和测试
1. 性能优化，避免频繁更新

## 5. 预期效果

### 5.1 简化开发
- 塔不需要手动设置层级
- 敌人预制体配置更简单
- 场景设施自动被管理，无需手动配置
- 新增enemy、tower、bullet、场景设施对象自动获得正确层级
- 遮挡关系完全由位置自动决定

### 5.2 统一管理
- enemy、tower、bullet、场景设施使用同一套层级系统
- 层级逻辑集中在一个管理器中
- 通过标签系统自动识别，无需手动挂脚本
- 易于维护和扩展

### 5.3 自动排序
- 根据Y轴位置自动调整渲染顺序
- 支持动态移动对象的层级更新
- 塔可以挡住敌人，敌人也可以挡住塔，完全由位置决定
- 场景设施也参与遮挡关系，床、电视、灯等都能正确遮挡
- 减少手动配置错误

## 6. 总结

这个简化的层级管理器将把enemy、tower、bullet、场景设施统一到一个Sorting Layer中，通过sortingOrder自动管理前后遮挡关系。移除复杂的多层设计和基数分类，实现基于位置的简单层级管理，让开发者专注于游戏逻辑而不是层级配置。塔可以挡住敌人，敌人也可以挡住塔，场景设施也能正确遮挡，完全由Y轴位置决定渲染顺序。通过标签系统自动识别对象，无需手动挂脚本，实现真正的自动化管理。
